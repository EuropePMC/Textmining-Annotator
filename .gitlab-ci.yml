stages:
  - security

gitleaks_repo_scan:
  variables:
    GIT_DEPTH: 0
  stage: security
  image: alpine:latest

  before_script:
    - apk add --no-cache curl git tar jq

    # install latest gitleaks
    - |
      GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name | sed 's/^v//')
      echo "Using Gitleaks ${GITLEAKS_VERSION}"
      curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz -o gitleaks.tar.gz
      tar -xzf gitleaks.tar.gz
      mv gitleaks /usr/local/bin/
      chmod +x /usr/local/bin/gitleaks

  script:
    # prepare folders
    - mkdir -p report_templates public

    # fetch report template FIRST
    - |
      curl -fsSL https://raw.githubusercontent.com/gitleaks/gitleaks/master/report_templates/basic.tmpl \
        -o report_templates/basic.tmpl

    # -----------------------------
    # 1) Scan current repository state
    # -----------------------------
    - echo "Running Gitleaks scan on working tree..."
    - |
      gitleaks dir . \
        --config .gitlab/gitleaks-custom.toml \
        --report-path "public/repo-scan.html" \
        --report-format template \
        --report-template report_templates/basic.tmpl

    # -----------------------------
    # 2) Scan full git history
    # -----------------------------
    - echo "Running Gitleaks scan on full git history..."
    - |
      gitleaks detect \
        --source . \
        --log-opts="--all" \
        --config .gitlab/gitleaks-custom.toml \
        --report-path "public/history-scan.html" \
        --report-format template \
        --report-template report_templates/basic.tmpl

  tags:
    - docker:dind

  artifacts:
    paths:
      - public
    expire_in: 1 week
    when: always